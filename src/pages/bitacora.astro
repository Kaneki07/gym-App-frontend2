---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Bitácora de Entrenamiento | Gym App">
  <div class="min-h-screen bg-gradient-to-b from-[#0a0a0a] to-[#111] pb-20">
    
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-8">
      
      <header class="mb-12 flex flex-col md:flex-row md:items-end justify-between gap-6 relative z-10">
        <div class="space-y-4">
          <a href="/dashboard" class="group inline-flex items-center gap-2 text-zinc-500 hover:text-white transition-all duration-300 text-xs font-bold uppercase tracking-widest">
             <div class="bg-zinc-800 p-1.5 rounded-full group-hover:bg-red-600 transition-colors">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" />
                 </svg>
             </div>
             Volver al panel
          </a>
          
          <div>
             <h1 class="text-4xl md:text-6xl font-black uppercase tracking-tighter text-white italic leading-none">
             Bitácora <span class="text-transparent bg-clip-text bg-gradient-to-br from-red-500 to-orange-600">Semanal</span>
             </h1>
             <p class="text-zinc-400 text-sm md:text-base mt-2 font-medium max-w-lg">
                El dolor es temporal, la gloria es eterna. Registra cada levantamiento.
             </p>
          </div>
        </div>
        
        <div class="flex gap-4">
          <button id="btn-save" class="relative group overflow-hidden w-full md:w-auto bg-white text-black px-8 py-3 rounded-xl font-black uppercase italic tracking-tighter transition-all duration-300 shadow-[0_0_20px_rgba(255,255,255,0.1)] hover:shadow-[0_0_20px_rgba(220,38,38,0.4)] active:scale-95 flex items-center justify-center gap-2 z-10">
             <div class="absolute inset-0 w-full h-full bg-gradient-to-r from-red-600 to-orange-600 opacity-0 group-hover:opacity-100 transition-opacity duration-300 -z-10"></div>
             <span class="group-hover:text-white transition-colors flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                </svg>
                Guardar Progreso
             </span>
          </button>
        </div>
      </header>
  
      <div id="bitacora-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 items-start">
         <div class="col-span-full text-white text-center py-20 opacity-50 italic animate-pulse">
            Cargando tu legado...
         </div>
      </div>

    </div>
  </div>
</Layout>

<script>
    // --- LÓGICA DEL FRONTEND ---
    const API_URL = 'https://gym-app-backend-2-pv91.onrender.com'; 
    const userStr = localStorage.getItem('user');
    const user = userStr ? JSON.parse(userStr) : null;
    
    if (!user) window.location.href = '/login';

    const days = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];
    let bitacoraData = {};
    let isUpdate = false; 

    // Inicializar estructura vacía
    days.forEach(day => {
        bitacoraData[day] = [];
    });

    const container = document.getElementById('bitacora-container');

    async function loadBitacora() {
        try {
            const res = await fetch(`${API_URL}/bitacora/${user.id}`);
            const result = await res.json();
            
            if (result.data && result.data.content) {
                bitacoraData = { ...bitacoraData, ...result.data.content };
                isUpdate = true; 
            }
            renderBitacora();
        } catch (error) {
            console.error("Error cargando bitácora", error);
            renderBitacora();
        }
    }

    function renderBitacora() {
        if (!container) return;
        container.innerHTML = '';

        days.forEach(day => {
            const daySection = document.createElement('div');
            // Estilo de tarjeta de Día
            daySection.className = "bg-[#161618] border border-white/5 rounded-2xl overflow-hidden shadow-lg transition-all hover:border-white/10 group/card";
            
            // Verificamos si es hoy para darle un estilo especial (opcional, lógica simple basada en fecha JS)
            const todayName = new Date().toLocaleDateString('es-ES', { weekday: 'long' });
            const isToday = todayName.toLowerCase() === day.toLowerCase();
            const accentColor = isToday ? 'bg-red-600' : 'bg-zinc-700';

            daySection.innerHTML = `
                <div class="px-5 py-4 border-b border-white/5 flex justify-between items-center bg-white/[0.02]">
                    <div class="flex items-center gap-3">
                        <span class="w-1.5 h-6 rounded-full ${accentColor} shadow-[0_0_10px_rgba(220,38,38,0.5)]"></span>
                        <h3 class="text-xl font-black text-white uppercase italic tracking-tighter">
                            ${day}
                        </h3>
                    </div>
                    <button onclick="window.addExercise('${day}')" class="w-8 h-8 rounded-full bg-zinc-800 hover:bg-white text-zinc-400 hover:text-black flex items-center justify-center transition-all duration-300 hover:scale-110 active:scale-90" title="Añadir ejercicio">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4" />
                        </svg>
                    </button>
                </div>
                
                <div id="list-${day}" class="p-3 space-y-3 min-h-[100px]">
                    ${bitacoraData[day].length === 0 ? 
                        `<div class="h-full flex flex-col items-center justify-center py-6 opacity-30 gap-2 select-none">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                            </svg>
                            <span class="text-xs font-medium uppercase tracking-widest">Descanso</span>
                         </div>` 
                        : ''}
                </div>
            `;

            container.appendChild(daySection);
            renderExercises(day);
        });
    }

    function renderExercises(day) {
        const list = document.getElementById(`list-${day}`);
        if (!list) return;
        list.innerHTML = ''; // Limpiamos para evitar duplicados visuales al renderizar

        bitacoraData[day].forEach((item, index) => {
            const div = document.createElement('div');
            div.className = "relative bg-black/40 rounded-xl p-3 border border-white/5 group hover:border-red-500/20 transition-all duration-300";
            
            const weightVal = item.weight || ''; 

            div.innerHTML = `
                <button onclick="window.removeExercise('${day}', ${index})" class="absolute -top-2 -right-2 bg-red-900/80 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 hover:bg-red-600 transition-all duration-200 shadow-md scale-75 group-hover:scale-100 z-10">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>

                <div class="mb-3">
                    <input type="text" placeholder="Nombre del Ejercicio" value="${item.name}" 
                        onchange="window.updateField('${day}', ${index}, 'name', this.value)"
                        class="w-full bg-transparent text-white font-bold text-base placeholder:text-zinc-600 focus:outline-none border-b border-transparent focus:border-red-600/50 transition-colors pb-1">
                </div>

                <div class="grid grid-cols-3 gap-2">
                    <div class="bg-zinc-900/50 rounded-lg p-1.5 flex flex-col items-center border border-white/5 focus-within:border-zinc-500 transition-colors">
                        <label class="text-[9px] text-zinc-500 uppercase font-bold tracking-wider mb-0.5 flex items-center gap-1">
                            <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                            Sets
                        </label>
                        <input type="number" placeholder="-" value="${item.series}" 
                            onchange="window.updateField('${day}', ${index}, 'series', this.value)"
                            class="w-full bg-transparent text-center font-mono text-sm text-zinc-300 focus:outline-none focus:text-white font-bold">
                    </div>

                    <div class="bg-zinc-900/50 rounded-lg p-1.5 flex flex-col items-center border border-white/5 focus-within:border-zinc-500 transition-colors">
                        <label class="text-[9px] text-zinc-500 uppercase font-bold tracking-wider mb-0.5 flex items-center gap-1">
                            <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                            Reps
                        </label>
                        <input type="number" placeholder="-" value="${item.reps}" 
                            onchange="window.updateField('${day}', ${index}, 'reps', this.value)"
                            class="w-full bg-transparent text-center font-mono text-sm text-zinc-300 focus:outline-none focus:text-white font-bold">
                    </div>

                    <div class="bg-zinc-800/80 rounded-lg p-1.5 flex flex-col items-center border border-red-900/30 focus-within:border-red-500 transition-colors shadow-inner">
                        <label class="text-[9px] text-red-400 uppercase font-bold tracking-wider mb-0.5 flex items-center gap-1">
                            <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" /></svg>
                            KG
                        </label>
                        <input type="number" placeholder="-" value="${weightVal}" 
                            onchange="window.updateField('${day}', ${index}, 'weight', this.value)"
                            class="w-full bg-transparent text-center font-mono text-sm text-white focus:outline-none focus:text-red-400 font-black">
                    </div>
                </div>
            `;
            list.appendChild(div);
        });
    }

    // --- TYPESCRIPT FIX & LOGIC ---
    (window as any).addExercise = (day) => {
        bitacoraData[day].push({ name: '', series: '', reps: '', weight: '' });
        // Solo re-renderizamos los ejercicios de ese día para mejor rendimiento
        renderExercises(day);
        
        // Remover el mensaje de "Descanso" si existe
        const list = document.getElementById(`list-${day}`);
        const emptyState = list.querySelector('.opacity-30'); // Clase específica del empty state
        if(emptyState) emptyState.remove();
    };

    (window as any).removeExercise = (day, index) => {
        bitacoraData[day].splice(index, 1);
        renderBitacora(); // Aquí si render completo para verificar si queda vacío y mostrar "Descanso"
    };

    (window as any).updateField = (day, index, field, value) => {
        bitacoraData[day][index][field] = value;
    };

    // GUARDAR O ACTUALIZAR EN BD
    document.getElementById('btn-save')?.addEventListener('click', async () => {
        const btn = document.getElementById('btn-save') as HTMLButtonElement;
        const originalContent = btn.innerHTML;
        
        const method = isUpdate ? 'PUT' : 'POST';

        try {
            btn.innerHTML = '<span class="animate-spin mr-2">⟳</span> Guardando...';
            btn.disabled = true;
            btn.classList.add('opacity-70');

            const res = await fetch(`${API_URL}/bitacora/${user.id}`, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content: bitacoraData })
            });

            if (res.ok) {
                btn.innerHTML = '<span class="text-green-400 mr-2 font-bold">✓</span> ¡Guardado!';
                setTimeout(() => {
                    btn.innerHTML = originalContent;
                    btn.disabled = false;
                    btn.classList.remove('opacity-70');
                }, 1500);
                isUpdate = true; 
            } else {
                alert('Error al guardar. Intenta nuevamente.');
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        } catch (error) {
            console.error(error);
            alert('Error de conexión con el servidor');
            btn.innerHTML = originalContent;
            btn.disabled = false;
        } 
    });

    loadBitacora();
</script>